## usage: x is the data.frame, items are the columns for the items,
## crit is the columns for the criterion variable.

carvedscales <- function(x,items,crit,...){
  UseMethod("carvedscales")
}

carvedscales.default <- function(x,itms,crt,boot=F,Nobs=NULL,iter=100){
  library(gregmisc)
  
  carvefcn <- function(items,crit,item.fin){
    crit.cor <- rep(NA,nrow(item.fin))
    ts.cor <- rep(NA,nrow(item.fin))
    for (i in 1:nrow(item.fin)){
      tmp <- items[,item.fin[i,]]
      if (is.null(ncol(tmp))){
        crit.cor[i] <- round(cor(tmp,crit),2)
        ts.cor[i] <- round(cor(tmp,total),2)
      } else {
        crit.cor[i] <- round(cor(rowSums(tmp),crit),2)
        ts.cor[i] <- round(cor(rowSums(tmp),total),2)
      }
    }
    out <- list(crit.cor=crit.cor,ts.cor=ts.cor)
    return(out)
  }
  
  if (boot==F){
    items <- x[,itms]
    crit <- x[,crt]
    total <- rowSums(items)
    item.sel <- permutations(2,ncol(items),c(T,F),repeats=T)
    item.fin <- item.sel[-1,]

    out <- carvefcn(items,crit,item.fin)
    crit.cor <- out[[1]]
    ts.cor <- out[[2]]
    
    crit.best <- match(max(abs(crit.cor)),abs(crit.cor))
    total.best <- match(max(abs(ts.cor[-length(ts.cor)])),abs(ts.cor[-length(ts.cor)]))
    crit.best.items <- names(items)[item.fin[crit.best,]]
    total.best.items <- names(items)[item.fin[total.best,]]

    res <- list(crit.cor=crit.cor,total.cor=ts.cor,items=item.fin,item.names=names(items),crit=names(x)[crt],crit.best=crit.best,total.best=total.best,crit.best.items=crit.best.items,total.best.items=total.best.items,boot=F)

  } else {

    out.dat <- data.frame(crit.best=rep(NA,iter),pattern=rep(NA,iter))
    
    for (i in 1:iter){
      tmp <- x[sample(1:nrow(x),Nobs,T),]
      items <- tmp[,itms]
      crit <- tmp[,crt]
      total <- rowSums(items)
      item.sel <- permutations(2,ncol(items),c(T,F),repeats=T)
      item.fin <- item.sel[-1,]
      
      out <- carvefcn(items,crit,item.fin)
      crit.cor <- out[[1]]

      out.dat[i,] <- c(max(abs(crit.cor)),match(max(abs(crit.cor)),abs(crit.cor)))
    }

    res <- list(out.dat=out.dat,items=item.fin,item.names=names(x)[itms],crit=names(x)[crt],boot=T)

  }
  class(res) <- "carvedscales"
  invisible(res)
  return(res)
}

    
summary.carvedscales <- function(x){
  maxcor.crit <- max(x$crit.cor)
  maxcor.ts <- max(x$total.cor[-length(x$total.cor)])
  regcor <- x$total.cor[length(x$total.cor)]
  
}

plot.carvedscales <- function(x){
  par(mfrow=c(1,2))
  hist(x$crit.cor,xlab="Correlation",main="Criterion")
  allcor <- x$crit.cor[length(x$crit.cor)]
  abline(v=allcor,col="red",lwd=2)
  abline(v=x$crit.cor[x$crit.best],col="blue",lwd=2)
  legend("topright",legend=c("Best","Total"),lty=1,lwd=2,col=c("blue","red"))

  hist(x$total.cor,xlab="Correlation",main="Total Score")
  abline(v=x$total.cor[x$total.best],col="blue",lwd=2)
  
  par(mfrow=c(1,1))
}

